\section{Gas usage and transaction costs}
\label{sec:gas}

\begin{table}[h]
\centering
\caption{Average gas usage from simulation.}
\label{tab:gas-usage}
\begin{tabular}{|l|l|l|l|}
\hline

transaction & single match & dual match & \# \\ \hline
create LotteryMaster & 1087189 & 1087125 & 1 \\ \hline
setFinalMatch & 49282 & 49282 & 1 \\ \hline
create LotteryMatch & 2472237 & - & N-1 \\ \hline
create FirstLevelMatch & - & 1693728 & N/2 \\ \hline
create InternalMatch & - & 1697819 & (N/2)-1 \\ \hline
initFirstLevelMatch & 74700 & - & N/2 \\ \hline
initInternalMatch & 71034 & - & (N/2)-1 \\ \hline
deposit & 73925 & 73925 & N \\ \hline
commit & 83548 & 88668 & 2(N-1) \\ \hline
reveal & 43035 & 42882 & 2(N-1) \\ \hline
withdraw & 39277 & 39177 & 1 \\ \hline

\end{tabular}
\end{table}

\noindent
Table \ref{tab:gas-usage} is a list of transactions made in a simulation with 256 participants. The left column describes the transaction made, while the right column is the number of transactions of this type needed to successfully play a lottery. The middle columns are the average gas usage for each transaction for two different lottery designs. In the first design, we use a single match contract for all types of matches whether they are first level or internal. In the second design, we have two separate match contracts for first level matches and internal matches. 

\begin{table}[h]
\centering
\caption{Organizer gas usage. Single match contract.}
\label{tab:org-gas-usage-single}
\begin{tabular}{|l|l|l|l|l|l|l|}
\hline

N & Gas & ETH & USD & Gas / N & ETH / N & USD / N \\ \hline
32 & 80023408 & 0.120 & 21.13 & 2500732 & 0.003751 & 0.660 \\ \hline
64 & 161466448 & 0.242 & 42.63 & 2522913 & 0.003784 & 0.666 \\ \hline
128 & 324354704 & 0.487 & 85.63 & 2534021 & 0.003801 & 0.669 \\ \hline
256 & 650139920 & 0.975 & 171.64 & 2539609 & 0.003809 & 0.670 \\ \hline

\end{tabular}
\end{table}

\begin{table}[h]
\centering
\caption{Total gas usage. Single match contract.}
\label{tab:total-gas-usage-single}
\begin{tabular}{|l|l|l|l|l|l|l|}
\hline

N & Gas & ETH & USD & Gas / N & ETH / N & USD / N \\ \hline
32 & 90297000 & 0.135 & 23.84 & 2821781 & 0.004233 & 0.745 \\ \hline
64 & 182203802 & 0.273 & 48.10 & 2846934 & 0.004270 & 0.752 \\ \hline
128 & 366020720 & 0.549 & 96.63 & 2859537 & 0.004289 & 0.755 \\ \hline
256 & 733661484 & 1.100 & 193.69 & 2865865 & 0.004299 & 0.757 \\ \hline

\end{tabular}
\end{table}

\begin{table}[h]
\centering
\caption{Organizer gas usage. Two types of match contracts.}
\label{tab:org-gas-usage-dual}
\begin{tabular}{|l|l|l|l|l|l|l|}
\hline

N & Gas & ETH & USD & Gas / N & ETH / N & USD / N \\ \hline
32 & 53690344 & 0.081 & 14.17 & 1677823 & 0.002517 & 0.443 \\ \hline
64 & 107956984 & 0.162 & 28.50 & 1686828 & 0.002530 & 0.445 \\ \hline
128 & 216490200 & 0.325 & 57.15 & 1691330 & 0.002537 & 0.447 \\ \hline
256 & 433556696 & 0.650 & 114.46 & 1693581 & 0.002540 & 0.447 \\ \hline

\end{tabular}
\end{table}

\begin{table}[h]
\centering
\caption{Total gas usage. Two types of match contracts.}
\label{tab:total-gas-usage-dual}
\begin{tabular}{|l|l|l|l|l|l|l|}
\hline

N & Gas & ETH & USD & Gas / N & ETH / N & USD / N \\ \hline
32 & 63896706 & 0.096 & 16.87 & 1996772 & 0.002995 & 0.527 \\ \hline
64 & 128557218 & 0.193 & 33.94 & 2008707 & 0.003013 & 0.530 \\ \hline
128 & 257880692 & 0.387 & 68.08 & 2014693 & 0.003022 & 0.532 \\ \hline
256 & 516523956 & 0.775 & 136.36 & 2017672 & 0.003027 & 0.533 \\ \hline

\end{tabular}
\end{table}

\noindent
Table \ref{tab:org-gas-usage-single} and \ref{tab:total-gas-usage-single} show the gas usage of only setting up and setting and playing a full lottery, respectively, for the design with a single type of match contract. Table Table \ref{tab:org-gas-usage-dual} and \ref{tab:total-gas-usage-dual} show the gas usage for the design with two types of match contracts, also showing for only setting up and setting up and playing a full lottery.
The dual match design compared to the single match design uses 44\% less gas to set up, and 36\% less gas to set up and play. As we can see in Table \ref{tab:gas-usage}, the savings come from deploying the match contracts. This is because we deploy less bytecode and declare fewer variables with the dial match design.

As was expected, the gas usage scales linearly with the number of participants. The gas usage increases by a minuscule amount per participant. For simulating the entire lifecycle of a lottery, this can be explained by the \texttt{deposit()} function which keeps expanding a dynamic array as players join.

We see that by far most gas is spent on deploying each individual match contract. This cost was significantly decreased by splitting the match contracts into two types, the \texttt{FirstLevelMatch} and \texttt{InternalMatch}. This is because each variable and each bit of bytecode contributes to the gas usage when deploying contracts. Decreasing the number of methods, decreasing the number and size of variables, and decreasing the number of instructions, i.e. lines of code, will decrease the gas usage. Since each match contract is not interacted with much – at most four times, two commits and two reveals – it seems wasteful to spend so much gas on deploying them on the blockchain permanently. This is a well-known issue, and it is possible to deduplicate common behaviour by using patterns involving \emph{library contracts} and \emph{proxy contracts}. \cite{lu_solidity_2018} demonstrate that gas usage for deploying contracts can decrease as much as 50\% by using these patterns. It could also be possible to do away with the dedicated match contracts completely, and handle everything in the master contract, but we leave that to future work or a practical implementation.

While the price of ether and by extension gas is known to fluctuate heavily in fiat terms, we choose to primarily consider the cost of running the lottery only in the context of ether and gas price, even though we will also mention the price in USD in some cases to provide context. The transaction costs depend entirely on gas usage and gas price, and can be made an arbitrarily low fraction of the ticket price if we can set the ticket price arbitrarily high. The gas price is also known for fluctuating somewhat in terms of ether, but it is simply a result of market demand for resources on the EVM. The gas price is not a fixed price, as there is essentially a bid and ask market with a spread, where transactors are bidders and miners are askers. By bidding with a low gas price, it means the probability of the transaction being included in a block is low, as miners are likely to include transactions with a higher gas price.
